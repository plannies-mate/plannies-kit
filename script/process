#!/bin/bash

# shellcheck disable=SC2317
error_handler() {
  local line_no=$1
  local error_code=$2
  echo "Error on line ${line_no} with exit code ${error_code}"
  case ${error_code} in
    1)
      echo "General error occurred"
      ;;
    2)
      echo "Missing repository directory"
      ;;
    *)
      echo "Unexpected error occurred"
      ;;
  esac
}

set -e
trap 'error_handler ${LINENO} $?' ERR

cd "$(dirname "$0")/.." || ( echo "Could not cd to project directory" ; exit 1 )

main() {
  # Only pass LIMIT if it was actually specified
  if [ -n "$1" ]; then
    LIMIT_ARG="$1"
    echo "Using limit: $LIMIT_ARG"
  else
    LIMIT_ARG=""
  fi

  # Change to project root
  cd "$PROJECT_ROOT"

  mkdir -p repos

  echo "Step 1: Downloading repositories..."
  # shellcheck disable=SC2086
  lib/download.rb $LIMIT_ARG
  echo -e "\nStep 2: Validating Download of repositories..."
  # shellcheck disable=SC2086
  lib/validate/download.rb $LIMIT_ARG

  echo -e "\nStep 3: Cleaning repositories..."
  lib/cleanup.rb
  echo -e "\nStep 4: Validating Clean of repositories..."
  lib/validate/cleanup.rb

  echo -e "\nStep 5: Analyzing code..."
  lib/analyze.rb
  echo -e "\nStep 6: Validating Analysis of code..."
  lib/validate/analyze.rb

  echo -e "\nProcess complete! Check the output above for the extraMatchWords hash."
}

main "$@" 2>&1 | tee log/process.log

exit 0
